{
  "name": "tapelab-worker",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "start": "node worker.js"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.45.0"
  }
}
import { createClient } from "@supabase/supabase-js";

const SUPABASE_URL = process.env.SUPABASE_URL;
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;
const WORKER_ID = process.env.WORKER_ID || "tapelab-worker-1";
const POLL_MS = Number(process.env.POLL_MS || 8000);

if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
  throw new Error("Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY");
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

async function claimNextJob() {
  const { data: jobs, error } = await supabase
    .from("processing_jobs")
    .select("*")
    .eq("status", "queued")
    .is("claimed_at", null)
    .order("created_at", { ascending: true })
    .limit(1);

  if (error) {
    console.error("Fetch queued jobs error:", error);
    return null;
  }
  if (!jobs || jobs.length === 0) return null;

  const job = jobs[0];
  const now = new Date().toISOString();

  const { data: claimed, error: claimErr } = await supabase
    .from("processing_jobs")
    .update({
      claimed_at: now,
      claimed_by: WORKER_ID,
      status: "processing",
      stage: "downloading",
      progress: 10
    })
    .eq("id", job.id)
    .is("claimed_at", null)
    .select()
    .maybeSingle();

  if (claimErr) {
    console.error("Claim error:", claimErr);
    return null;
  }

  return claimed || null;
}

async function processJob(job) {
  try {
    console.log("Processing job:", job.id);

    await supabase
      .from("processing_jobs")
      .update({ stage: "cutting", progress: 35 })
      .eq("id", job.id);
    await new Promise((r) => setTimeout(r, 2000));

    await supabase
      .from("processing_jobs")
      .update({ stage: "rendering", progress: 70 })
      .eq("id", job.id);
    await new Promise((r) => setTimeout(r, 2500));

    await supabase
      .from("processing_jobs")
      .update({ stage: "uploading", progress: 90 })
      .eq("id", job.id);
    await new Promise((r) => setTimeout(r, 1500));

    await supabase
      .from("processing_jobs")
      .update({
        status: "completed",
        stage: "finalizing",
        progress: 100,
        output_reel_path: `outputs/${job.user_id}/${job.id}/reel.mp4`
      })
      .eq("id", job.id);

    console.log("Completed job:", job.id);
  } catch (e) {
    console.error("Job failed:", job.id, e);
    await supabase
      .from("processing_jobs")
      .update({
        status: "failed",
        stage: "failed",
        error_message: String(e?.message || e)
      })
      .eq("id", job.id);
  }
}

async function loop() {
  const job = await claimNextJob();
  if (job) await processJob(job);
}

console.log("TapeLab worker runningâ€¦", { WORKER_ID, POLL_MS });
setInterval(loop, POLL_MS);
loop();
